<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PhD Habit Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, sans-serif; }
  </style>
</head>

<body class="bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-gray-100">
<div id="root"></div>

<script type="text/babel">

/* -------------------- Utilities -------------------- */

const todayISO = () => new Date().toISOString().slice(0,10);

const getWeekKey = (dateStr) => {
  const d = new Date(dateStr);
  const firstJan = new Date(d.getFullYear(), 0, 1);
  const week = Math.ceil((((d - firstJan) / 86400000) + firstJan.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
};

/* -------------------- App -------------------- */

const App = () => {
  const [data, setData] = React.useState(() => {
    const saved = localStorage.getItem("phd-habit-data");
    return saved ? JSON.parse(saved) : {
      meta: { created: todayISO(), version: 1 },
      habits: {},
      logs: {}
    };
  });

  const [view, setView] = React.useState("daily");
  const [selectedDate, setSelectedDate] = React.useState(todayISO());

  React.useEffect(() => {
    localStorage.setItem("phd-habit-data", JSON.stringify(data));
  }, [data]);

  /* -------------------- Habit Logic -------------------- */

  const activeHabits = Object.values(data.habits)
    .filter(h =>
      !h.archived &&
      h.activeFrom <= selectedDate &&
      (!h.activeTo || h.activeTo >= selectedDate)
    );

  const logValue = (habitId, value, note="") => {
    setData(prev => {
      const logs = {...prev.logs};
      if (!logs[selectedDate]) logs[selectedDate] = {};
      logs[selectedDate][habitId] = { value, note };
      return { ...prev, logs };
    });
  };

  /* -------------------- Views -------------------- */

  return (
    <div className="max-w-5xl mx-auto p-4 space-y-6">
      <Header view={view} setView={setView} />

      {view === "daily" && (
        <DailyView
          date={selectedDate}
          setDate={setSelectedDate}
          habits={activeHabits}
          logs={data.logs[selectedDate] || {}}
          onLog={logValue}
        />
      )}

      {view === "habits" && (
        <HabitManager data={data} setData={setData} />
      )}

      {view === "review" && (
        <ReviewView data={data} />
      )}

      <ExportPanel data={data} />
    </div>
  );
};

/* -------------------- Components -------------------- */

const Header = ({view, setView}) => (
  <div className="flex gap-2">
    {["daily","habits","review"].map(v => (
      <button key={v}
        onClick={() => setView(v)}
        className={`px-4 py-2 rounded ${view===v ? "bg-emerald-600 text-white" : "bg-gray-200 dark:bg-slate-700"}`}>
        {v.toUpperCase()}
      </button>
    ))}
  </div>
);

/* -------- Daily Review -------- */

const DailyView = ({date, setDate, habits, logs, onLog}) => (
  <div className="bg-white dark:bg-slate-800 p-4 rounded shadow">
    <h2 className="text-xl font-bold mb-4">Daily Review</h2>

    <input type="date"
      value={date}
      onChange={e => setDate(e.target.value)}
      className="mb-4 px-2 py-1 border rounded"/>

    {habits.length === 0 && <p className="text-gray-500">No active habits</p>}

    <div className="space-y-3">
      {habits.map(h => (
        <div key={h.id} className="flex items-center gap-3">
          <div className="flex-1">
            <div className="font-medium">{h.name}</div>
            <div className="text-xs text-gray-500">
              Min: {h.minThreshold} {h.unit}
            </div>
          </div>

          <input type="number"
            className="w-24 px-2 py-1 border rounded"
            defaultValue={logs[h.id]?.value || ""}
            onBlur={e => onLog(h.id, Number(e.target.value))}
          />
        </div>
      ))}
    </div>
  </div>
);

/* -------- Habit Manager -------- */

const HabitManager = ({data, setData}) => {
  const [name,setName]=React.useState("");
  const [unit,setUnit]=React.useState("minutes");
  const [min,setMin]=React.useState(30);

  const addHabit = () => {
    const id = "h"+Date.now();
    setData(prev => ({
      ...prev,
      habits: {
        ...prev.habits,
        [id]: {
          id, name, unit,
          minThreshold: min,
          period:"day",
          activeFrom: todayISO(),
          activeTo:null,
          archived:false
        }
      }
    }));
    setName("");
  };

  return (
    <div className="bg-white dark:bg-slate-800 p-4 rounded shadow space-y-4">
      <h2 className="text-xl font-bold">Habit Manager</h2>

      <div className="flex gap-2">
        <input placeholder="Habit name" value={name}
          onChange={e=>setName(e.target.value)}
          className="px-2 py-1 border rounded flex-1"/>

        <input type="number" value={min}
          onChange={e=>setMin(Number(e.target.value))}
          className="w-20 px-2 py-1 border rounded"/>

        <button onClick={addHabit}
          className="bg-emerald-600 text-white px-4 rounded">
          Add
        </button>
      </div>

      <ul className="text-sm">
        {Object.values(data.habits).map(h=>(
          <li key={h.id} className="flex justify-between">
            {h.name}
            {h.archived ? "(archived)" : ""}
          </li>
        ))}
      </ul>
    </div>
  );
};

/* -------- Review -------- */

const ReviewView = ({data}) => {
  const weeks = {};

  Object.entries(data.logs).forEach(([date,entries])=>{
    const wk = getWeekKey(date);
    if(!weeks[wk]) weeks[wk]={};
    Object.entries(entries).forEach(([hid,val])=>{
      weeks[wk][hid]=(weeks[wk][hid]||0)+val.value;
    });
  });

  return (
    <div className="bg-white dark:bg-slate-800 p-4 rounded shadow">
      <h2 className="text-xl font-bold mb-4">Weekly Patterns</h2>
      <pre className="text-xs">{JSON.stringify(weeks,null,2)}</pre>
    </div>
  );
};

/* -------- Export -------- */

const ExportPanel = ({data}) => (
  <button
    onClick={()=>{
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="phd-habit-data.json";
      a.click();
    }}
    className="bg-gray-300 dark:bg-slate-700 px-4 py-2 rounded">
    Export Data
  </button>
);

/* -------------------- Render -------------------- */

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
